services:
  cms:
    build:
      context: ./thecodemuse/cms
      dockerfile: Dockerfile
    ports:
      - "1437:1337"
    env_file:
      - .env.staging
    environment:
      - NODE_ENV=production
      - APP_ENV=staging
      - HOST=0.0.0.0
      - PORT=1337
    restart: unless-stopped
    volumes:
      - cms_uploads:/app/public/uploads
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:1337/_health', (res) => process.exit(res.statusCode >= 200 && res.statusCode < 300 ? 0 : 1)).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 1G

  frontend:
    build:
      context: ./thecodemuse/frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_STRAPI_URL=https://staging.thecodemuse.com/cms
        - NEXT_PUBLIC_STRAPI_API_URL=https://staging.thecodemuse.com/cms/api
        - NEXT_PUBLIC_STRAPI_GRAPHQL_URL=https://staging.thecodemuse.com/cms/graphql
    ports:
      - "3100:3000"
    environment:
      - NODE_ENV=production
      - STRAPI_SERVER_URL=http://cms:1337
    depends_on:
      cms:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/api/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M

  email-service:
    build:
      context: ./muse-email-service
      dockerfile: Dockerfile
    ports:
      - "3130:3030"
    env_file:
      - .env.staging
    environment:
      - NODE_ENV=staging
      - PORT=3030
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3030/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M

volumes:
  cms_uploads:
